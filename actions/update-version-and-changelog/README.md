# Report deployment

A simple action that updates the application version and the CHANGELOG.md file during the pre-release process.

## How to use it?

In a workflow use this action in a `prepare-release` job that runs on `pull_requests` event to the `staging` branch.

### Pre-requisits

- The repo's code needs to be checkout using [actions/checkout](https://github.com/actions/checkout)
  - To be able to push the updates to the repo the checkout needs to be done using the `GIGAPIPEBOT_PAT`, look [here for an example](https://github.com/gigapipehq/github-actions/blob/main/workflows/staging-automation/javascript-projects.yml)
- The `mikepenz/release-changelog-builder-action` action needs to have been executed in a previous job so you have access to the generated changelog to use it as input of the action.

### Inputs

| **Inputs**           | **Description**                                                                                           | **Required** | **Default/Allowed values**                                                             |
| -------------------- | --------------------------------------------------------------------------------------------------------- | ------------ | -------------------------------------------------------------------------------------- |
| `changelogContent`   | The content generated by the release-changelog-builder-action                                             | true         |                                                                                        |
| `changelogFile`      | Path to the file containing the changelog.                                                                | false        | `./CHANGELOG.md`                                                                       |
| `appLanguage`        | The programing language of the application.                                                               | true         | `javascript`, `python` and `golang`                                                    |
| `versioningFilePath` | Path to the file containing the stored application version.                                               | false        | Depending on `appLanguage` could be `package.json`, `app/__init__.py` or `version.txt` |
| `token`              | Personal access token with enough permissions to interact with the repo and its branches.                 | false        | `secrets.GITHUB_TOKEN`                                                                 |
| `commiterName`       | The name of the GitHub user to use in the commit message that updates the changelog and versioning file.  | false        | Gigapipe Bot                                                                           |
| `commiterEmail`      | The email of the GitHub user to use in the commit message that updates the changelog and versioning file. | false        | engineering@gigapipe.com                                                               |

### Example

The example shows how this action can be used to report the deployed version of an application.

```yml
name: 'CI'
on:
  push:
    branches:
      - staging
  pull_request:
    types: [opened, reopened]
    branches:
      - staging

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    if: "${{ github.event_name == 'pull_request' }}"
    steps:
    - name: Checkout
        uses: actions/checkout@v3.0.2
      with:
        # This is necessary in order for GigapipeBot user to be able to commit to the HEAD branch that opened the PR against staging.
        # Usually it will be an rc or hotfix branch.
        token: ${{ secrets.GIGAPIPEBOT_PAT }}

    - name: Build Changelog
      id: build_changelog
      uses: mikepenz/release-changelog-builder-action@v3.0.0
      with:
        configuration: '.github/changelog_config.json'
        failOnError: true
        toTag: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update version and changelog files
        id: update_version
        uses: gigapipehq/github-actions/actions/update-version-and-changelog@main
        with:
          changelogContent: ${{steps.build_changelog.outputs.changelog}}
          appLanguage: 'javascript'

```
